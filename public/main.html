<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GAMESROOMWORLD - Unified</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="main.css">
</head>
<body>
  <header class="header">
    <a href="#admin" class="admin-btn" onclick="showSection('admin')">Admin</a>
    <div class="logo">
      <span class="logo-main">GAMESROOMWORLD</span>
      <span class="subtitle">(or not)</span>
    </div>
  </header>
  <main>
    <!-- Home Section -->
    <section class="intro-section" id="homeSection">
      <div class="intro-card">
        <h2>Welcome!</h2>
        <p>
          Welcome to our new project: a full stack website for rooms of many different games, including PS2 and more!
        </p>
      </div>
      <section class="games-section">
        <h2>PS2 Games For You</h2>
        <a href="#games" class="games-link" onclick="showSection('games')">Go to Game Rooms</a>
      </section>
    </section>
    <!-- Games List Section -->
    <section id="gamesSection" class="hidden-section">
      <div class="container">
        <h1>PlayStation 2 Games</h1>
        <form class="search-bar" action="#" method="get" autocomplete="off" onsubmit="return false;">
          <input type="text" placeholder="Search games..." name="search" id="searchInput">
          <button type="submit" id="searchBtn">Search</button>
        </form>
        <div class="game-list" id="gameList"></div>
      </div>
    </section>
    <!-- Game Details Section -->
    <section id="detailsSection" class="hidden-section">
      <div class="container details" id="gameContainer"></div>
    </section>
    <!-- Admin Section -->
    <section id="adminSection" class="hidden-section">
      <div class="admin-container">
        <h2>Admin Panel</h2>
        <div id="formSection">
          <h2 id="formTitle">Add New Game</h2>
          <input id="title" placeholder="Game Title">
          <input id="slug" placeholder="Slug (ex: gta-san-andreas)">
          <input id="image" placeholder="Image URL">
          <input id="genre" placeholder="Genre">
          <input id="size" placeholder="ISO Size">
          <input id="releaseYear" placeholder="Release Year">
          <textarea id="description" placeholder="Description"></textarea>
          <input id="downloadLink" placeholder="Download Link">
          <input id="youtube" placeholder="YouTube Video Embed URL">
          <button onclick="saveGame()" id="saveBtn">Add Game</button>
          <button onclick="resetForm()" id="cancelBtn" class="hidden">Cancel</button>
        </div>
        <div class="game-list-admin" id="gameListAdmin"></div>
      </div>
    </section>
  </main>
  <footer>
    <div class="footer-content">
      &copy; 2025 GAMESROOMWORLD. All rights reserved.
    </div>
  </footer>
  <script>
    // Section navigation
    function showSection(section) {
      document.getElementById('homeSection').classList.add('hidden-section');
      document.getElementById('gamesSection').classList.add('hidden-section');
      document.getElementById('detailsSection').classList.add('hidden-section');
      document.getElementById('adminSection').classList.add('hidden-section');
      if(section === 'home') document.getElementById('homeSection').classList.remove('hidden-section');
      if(section === 'games') {
        document.getElementById('gamesSection').classList.remove('hidden-section');
        fetchGames();
      }
      if(section === 'details') document.getElementById('detailsSection').classList.remove('hidden-section');
      if(section === 'admin') {
        document.getElementById('adminSection').classList.remove('hidden-section');
        renderGameList();
      }
    }
    // --- Games List Logic ---
    let games = [];
    async function fetchGames() {
      const res = await fetch('/api/games');
      games = await res.json();
      renderGames(games);
    }
    function renderGames(gamesToRender) {
      const gameList = document.getElementById('gameList');
      if (!gameList) return;
      gameList.innerHTML = '';
      if (gamesToRender.length === 0) {
        gameList.innerHTML = '<p style="text-align:center;color:#888;">No games found.</p>';
        return;
      }
      gamesToRender.forEach(game => {
        const card = document.createElement('div');
        card.className = 'game-card';
        card.innerHTML = `
          <img src="${game.image}" alt="${game.title}">
          <a class="game-title" href="#details" onclick="showGameDetails('${game.slug}')">${game.title}</a>
          <div class="game-desc">${game.description || ''}</div>
          <a class="single-link" href="#details" onclick="showGameDetails('${game.slug}')">View Details</a>
        `;
        gameList.appendChild(card);
      });
    }
    // Search
    document.addEventListener('DOMContentLoaded', function () {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function () {
          const query = searchInput.value.toLowerCase();
          const filtered = games.filter(game =>
            game.title.toLowerCase().includes(query) ||
            (game.description && game.description.toLowerCase().includes(query))
          );
          renderGames(filtered);
        });
      }
    });
    // --- Game Details Logic ---
    async function showGameDetails(slug) {
      showSection('details');
      let gamesArr = games.length ? games : await (await fetch('/api/games')).json();
      const game = gamesArr.find(g => g.slug === slug);
      const container = document.getElementById('gameContainer');
      if (!game) {
        container.innerHTML = '<h2 style="text-align:center;color:#ff5555;">Game not found</h2>';
        return;
      }
      container.innerHTML = `
        <div class="game-cover">
          <img src="${game.image}" alt="${game.title} Cover">
        </div>
        <div class="game-title details">${game.title}</div>
        <div class="game-info">
          <div>
            <div class="info-label">Platform:</div>
            PlayStation 2
          </div>
          <div>
            <div class="info-label">Size:</div>
            ${game.size || 'N/A'}
          </div>
          <div>
            <div class="info-label">Genre:</div>
            ${game.genre || 'N/A'}
          </div>
          <div>
            <div class="info-label">Release Year:</div>
            ${game.releaseYear || 'N/A'}
          </div>
          <div class="description">
            <div class="info-label">Description:</div>
            ${game.description || ''}
          </div>
        </div>
        ${game.downloadLink ? `<a class="download-btn" href="${game.downloadLink}" target="_blank" rel="noopener">DOWNLOAD NOW</a>` : `<span class="download-btn" aria-disabled="true">DOWNLOAD NOT AVAILABLE</span>`}
        <div class="video-section">
          <h3>Gameplay Video</h3>
          <div class="video-wrapper">
            ${game.youtube ? `<iframe src="${game.youtube}" allowfullscreen></iframe>` : '<p style="color:#888;">No video available.</p>'}
          </div>
        </div>
        <div style="margin-top:32px;text-align:center;">
          <a href="#games" style="color:#4fc3f7;text-decoration:underline;" onclick="showSection('games')">&#8592; Back to Games List</a>
        </div>
      `;
    }
    // --- Admin Panel Logic ---
    let editIndex = null;
    let adminGamesCache = [];
    async function getGames() {
      const res = await fetch('/api/games');
      return await res.json();
    }
    async function saveGame() {
      const game = {
        title: document.getElementById('title').value.trim(),
        slug: document.getElementById('slug').value.trim(),
        image: document.getElementById('image').value.trim(),
        genre: document.getElementById('genre').value.trim(),
        size: document.getElementById('size').value.trim(),
        releaseYear: document.getElementById('releaseYear').value.trim(),
        description: document.getElementById('description').value.trim(),
        downloadLink: document.getElementById('downloadLink').value.trim(),
        youtube: document.getElementById('youtube').value.trim()
      };
      if (!game.title || !game.slug) {
        alert('Title and Slug are required!');
        return;
      }
      if (editIndex !== null) {
        // Edit mode: use the original slug for lookup
        const originalSlug = adminGamesCache[editIndex]?.slug;
        await fetch(`/api/games/${encodeURIComponent(originalSlug)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(game)
        });
        document.getElementById('cancelBtn').classList.add('hidden');
      } else {
        // Add mode
        await fetch('/api/games', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(game)
        });
      }
      resetForm();
      await renderGameList();
    }
    async function renderGameList() {
      const games = await getGames();
      adminGamesCache = games;
      const list = document.getElementById('gameListAdmin');
      list.innerHTML = '';
      if (!games.length) {
        list.innerHTML = '<p style="color:#888;text-align:center;">No games found.</p>';
        return;
      }
      games.forEach((game, idx) => {
        const div = document.createElement('div');
        div.className = 'game-item';
        div.innerHTML = `
          <span class="game-item-title">${game.title}</span>
          <button class="edit-btn" onclick="editGame(${idx})">Edit</button>
          <button class="delete-btn" onclick="deleteGame(${idx})">Delete</button>
        `;
        list.appendChild(div);
      });
    }
    async function editGame(idx) {
      const games = adminGamesCache.length ? adminGamesCache : await getGames();
      const game = games[idx];
      if (!game) return;
      document.getElementById('formTitle').innerText = 'Edit Game';
      document.getElementById('title').value = game.title;
      document.getElementById('slug').value = game.slug;
      document.getElementById('image').value = game.image;
      document.getElementById('genre').value = game.genre;
      document.getElementById('size').value = game.size;
      document.getElementById('releaseYear').value = game.releaseYear;
      document.getElementById('description').value = game.description;
      document.getElementById('downloadLink').value = game.downloadLink;
      document.getElementById('youtube').value = game.youtube;
      editIndex = idx;
      document.getElementById('saveBtn').innerText = 'Save Changes';
      document.getElementById('cancelBtn').classList.remove('hidden');
    }
    async function deleteGame(idx) {
      const games = adminGamesCache.length ? adminGamesCache : await getGames();
      const game = games[idx];
      if (!game) return;
      if (!confirm(`Delete game: ${game.title}?`)) return;
      await fetch(`/api/games/${encodeURIComponent(game.slug)}`, { method: 'DELETE' });
      await renderGameList();
      resetForm();
    }
    function resetForm() {
      document.getElementById('formTitle').innerText = 'Add New Game';
      document.getElementById('saveBtn').innerText = 'Add Game';
      document.getElementById('title').value = '';
      document.getElementById('slug').value = '';
      document.getElementById('image').value = '';
      document.getElementById('genre').value = '';
      document.getElementById('size').value = '';
      document.getElementById('releaseYear').value = '';
      document.getElementById('description').value = '';
      document.getElementById('downloadLink').value = '';
      document.getElementById('youtube').value = '';
      editIndex = null;
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('saveBtn').innerText = 'Add Game';
    }
    // Expose functions globally for inline onclick
    window.deleteGame = deleteGame;
    window.editGame = editGame;
    // Render list on load for admin
    if(window.location.hash === '#admin') renderGameList();
  </script>
</body>
</html>
